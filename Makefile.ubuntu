.PHONY: all clean run setup

TARGET := Bridge

SRCS := \
PAL/HAPPlatformSystemInit.c \
Applications/Bridge/App.c \
Applications/Bridge/light.c \
Applications/Bridge/mesh.c \
Applications/Bridge/uart.c \
Applications/Bridge/DB.c \
Applications/Bridge/Main.c \
Applications/Bridge/switch.c \
HAP/HAPBLEAccessoryServer.c \
HAP/HAPPairingPairVerify.c \
HAP/HAPBLECharacteristicParseAndWriteValue.c \
HAP/HAPPDU.c \
HAP/HAPBLETransaction.c \
HAP/HAPRequestHandlers+HAPProtocolInformation.c \
HAP/HAPCharacteristic.c \
HAP/HAPTLV.c \
HAP/HAPAccessory+Info.c \
HAP/HAPRequestHandlers+AccessoryInformation.c \
HAP/HAPBLEService+Signature.c \
HAP/HAPIPSecurityProtocol.c \
HAP/HAPBLEPDU+TLV.c \
HAP/HAPIPAccessory.c \
HAP/HAPBLEPeripheralManager.c \
HAP/HAPStringBuilder.c \
HAP/HAPIPCharacteristic.c \
HAP/HAPBLECharacteristic.c \
HAP/HAPBLECharacteristicReadAndSerializeValue.c \
HAP/HAPIPServiceDiscovery.c \
HAP/HAPUUID.c \
HAP/HAPIPAccessoryServer.c \
HAP/HAPServiceTypes.c \
HAP/HAPRequestHandlers+Pairing.c \
HAP/HAPLegacyImport.c \
HAP/HAPCharacteristicTypes.c \
HAP/HAPPairing.c \
HAP/HAPPairingPairings.c \
HAP/HAPAccessorySetup.c \
HAP/HAPMACAddress.c \
HAP/HAPIPAccessoryProtocol.c \
HAP/HAPBLEPDU.c \
HAP/HAPBLECharacteristic+Signature.c \
HAP/HAPBLEAccessoryServer+Broadcast.c \
HAP/HAPAccessoryValidation.c \
HAP/HAPBLEProcedure.c \
HAP/HAPTLVWriter.c \
HAP/HAPMFiTokenAuth.c \
HAP/HAPBLESession.c \
HAP/HAPDeviceID.c \
HAP/HAPBLECharacteristic+Configuration.c \
HAP/HAPRequestHandlers.c \
HAP/HAPBLEAccessoryServer+Advertising.c \
HAP/HAPPairingPairSetup.c \
HAP/HAPTLVReader.c \
HAP/HAPIP+ByteBuffer.c \
HAP/HAPBLECharacteristic+Broadcast.c \
HAP/HAPAccessoryServer+Reset.c \
HAP/HAPAccessorySetupInfo.c \
HAP/HAPAccessoryServer.c \
HAP/HAPBitSet.c \
HAP/HAPVersion.c \
HAP/HAPSession.c \
HAP/HAPBLEProtocol+Configuration.c \
HAP/HAPPairingBLESessionCache.c \
HAP/HAPMFiHWAuth.c \
HAP/HAPJSONUtils.c \
HAP/HAPTLVMemory.c \
PAL/HAPBase+Float.c \
PAL/HAPBase+MACAddress.c \
PAL/HAPAssert.c \
PAL/HAPBase+RawBuffer.c \
PAL/HAPBase+Double.c \
PAL/HAPBase+Int.c \
PAL/HAPBase+Crypto.c \
PAL/HAPBase+String.c \
PAL/HAPLog.c \
PAL/HAPBase+Sha1Checksum.c \
PAL/HAPBase+UTF8.c \
External/HTTP/util_http_reader.c \
External/JSON/util_json_reader.c \
External/Base64/util_base64.c \
PAL/Raspi/HAPPlatformRunLoop.c \
PAL/Raspi/HAPPlatformClock.c \
PAL/Raspi/HAPPlatformMFiHWAuth.c \
PAL/Raspi/HAPPlatformRandomNumber.c \
PAL/Raspi/HAPPlatformBLEPeripheralManager.c \
PAL/Raspi/HAPPlatformAccessorySetupDisplay.c \
PAL/Raspi/HAPPlatformServiceDiscovery.c \
PAL/Raspi/HAPPlatformAccessorySetup.c \
PAL/Raspi/HAPPlatformKeyValueStore.c \
PAL/Raspi/HAPPlatformAbort.c \
PAL/Raspi/HAPPlatformFileManager.c \
PAL/Raspi/HAPPlatformTCPStreamManager.c \
PAL/Raspi/HAPPlatformSystemCommand.c \
PAL/Raspi/HAPPlatform.c \
PAL/Raspi/HAPPlatformMFiTokenAuth.c \
PAL/Raspi/HAPPlatformAccessorySetupNFC.c \
PAL/Raspi/HAPPlatformLog.c \
PAL/Crypto/OpenSSL/HAPOpenSSL.c

INCS := \
-IHAP \
-IExternal/HTTP \
-IExternal/JSON \
-IExternal/Base64 \
-I/include \
-IPAL \
-IPAL/Raspi

DEFS := \
-DHAP_ENABLE_DEVELOPMENT_ONLY_CODE=1 \
-DHAP_LOG_LEVEL=2 \
-DHAP_TESTING \
-DHAP_Debug \
-DIP=1

CCFLAGS := \
-ffunction-sections \
-fdata-sections \
-O0 \
-g \

LDFLAGS := \
-ldns_sd \
-pthread \
-lm \
-L/lib \
-lcrypto

OBJS := $(addprefix out/,$(subst .c,.o,$(SRCS)))

CC := clang

all: out/$(TARGET)

out/$(TARGET): $(OBJS)
	@echo Linking $@
	@$(CC) -Wl,--start-group $(LDFLAGS) $^ -Wl,--end-group -o $@
	@echo Done

-include $(subst .o,.d,$(OBJS))

# $(OBJS): out/%.o: %.c
out/%.o: %.c
	@echo Compiling $<
	@-mkdir -p $(dir $@)
	@$(CC) $(INCS) $(DEFS) $(CCFLAGS) -MMD -c $< -o $@

clean:
	@-rm -rf out
	@echo Done

run: ./out/Bridge
	./out/Bridge

Output/Raspi-x86_64-pc-Raspi-gnu/Debug/Tools/AccessorySetupGenerator.OpenSSL:
	make tools

setup: Output/Raspi-x86_64-pc-Raspi-gnu/Debug/Tools/AccessorySetupGenerator.OpenSSL
	rm -rf .HomeKitStore
	Tools/provision_raspi.sh --category 5 --setup-code 111-22-333 --setup-id SNOW .HomeKitStore